# CtrlBoard-H7 IMU Usage Guide

This document explains how to set up, build, flash, and operate the CtrlBoard-H7_IMU firmware. It also lists the runtime interfaces that the application exposes so that you can integrate it into a larger robotics stack.

## 1. Prerequisites

### Hardware

- STM32H723 based control board with the IMU and power stage populated.
- ST-LINK/V3 (or compatible) programmer/debugger.
- USB Type-C cable for the USB HS/CDC interface.
- CAN transceiver wiring to your actuator network (DM4310/DM4340/DM3507/etc.).
- 24 V DC bench supply that can source the current required by the connected actuators.

### Software

- **Keil MDK-ARM** (version 5.38a or newer) with the ARM Compiler 5 toolchain.
- **STM32CubeMX** for regenerating peripheral initialisation code (optional, only required when editing `.ioc`).
- ST-LINK USB drivers (for Windows hosts).
- Python 3.10+ with `pyserial` if you plan to log data from the USB CDC port.

## 2. Repository Structure Overview

| Path | Description |
| ---- | ----------- |
| `Core/` | Application-level source files generated by STM32CubeMX (main entry point, interrupt handlers, peripheral configuration helpers). |
| `User/` | Hand-written modules for motor drivers, filters, control logic, and RTOS tasks. |
| `USB_DEVICE/` | USB CDC class implementation and descriptors. |
| `MDK-ARM/` | Keil project files (`CtrlBoard-H7_IMU.uvprojx`, `CtrlBoard-H7_IMU.uvoptx`). |
| `Drivers/` | STM32 HAL, BSP, and CMSIS dependencies. |
| `Middlewares/` | FreeRTOS kernel sources. |

## 3. Building the Firmware

1. **Open the project**
   - Launch Keil µVision and open `MDK-ARM/CtrlBoard-H7_IMU.uvprojx`.

2. **Select the target**
   - Ensure that `CtrlBoard-H7_IMU` is the active build target in the project explorer.

3. **Configure the toolchain**
   - In *Project → Options for Target → Target*, verify the following:
     - Device: `STM32H723ZGTx`.
     - Use the ARM Compiler 5 toolchain (`ARMCC`).
     - Floating-point hardware: `FPv5-SP-D16` with hard ABI.

4. **Build**
   - Click the *Rebuild* button (or press `Ctrl` + `F7`).
   - The project should compile without warnings. If you see warnings, re-run code generation or ensure that your Keil packs are up to date.

5. **Flash**
   - Connect the ST-LINK probe to the SWD header.
   - In µVision, click *Download* (or press `F8`) to program the MCU.

## 4. Runtime Interfaces

### 4.1 USB CDC High-Speed Port

- Enumerates as a virtual COM port at 2 Mbaud with 8N1 framing.
- Receives 11-byte feedback frames defined in `User/Devices/DM_Motor/dm4310_drv.c`.
- The firmware checks for the `FRAME_HEADER` byte, validates the checksum using `Check_Sum`, and dispatches the payload to the appropriate motor profile via `CDC_DispatchFeedback`.
- Use a terminal or Python script (see sample below) to capture telemetry:

```python
import serial

ser = serial.Serial('COM10', baudrate=2000000, timeout=0.2)
ser.write(b'\xAA...')  # send command frame here
frame = ser.read(11)
print(frame)
```

### 4.2 CAN Motor Bus

- Supports DM series actuators (DM4310, DM4340, DM6006, DM8006, DM3507, DM10010L, DM6248P).
- Feedback frames are decoded in `dm4310_drv.c` and stored into `Joint_Motor_t` structures.
- Control commands are sent via `mit_ctrl*` helpers, while velocity-only control uses `speed_ctrl`.
- Ensure the CAN bus is terminated and configured at the rate specified in `fdcan.c` (default: 1 Mbps nominal / 2 Mbps data phase).

### 4.3 FreeRTOS Tasks

Important tasks (see `User/Task` sources):

- `connect_task`: handles host communications and diagnostics.
- `controller`: main control loop dispatching commands to the actuators.
- `chassisL_task` / `chassisR_task`: left/right leg or wheel controllers.
- `body_task`: IMU fusion and balance control.

Tune task priorities and stack sizes in `freertos.c` if you add custom workloads.

## 5. Configuration & Calibration

1. **Motor Profiles**
   - Configure which joints are monitored via `ControlBoardProfile` definitions (see `User/Controller/control_board_profile.c`).
   - The new DM3507 telemetry helper (`dm3507_fbdata_test`) enables full MIT frame decoding for DM3507 actuators.

2. **PID Parameters**
   - Adjust PID gains in `User/Controller/pid.c` or the relevant task modules.

3. **IMU Orientation**
   - Ensure the quaternion/Kalman filters (`User/IMU`) are calibrated by leaving the robot stationary for a few seconds after boot.

4. **Safety**
   - Always start with the robot lifted from the ground while validating new control algorithms.
   - Use the `vbus_check` task to monitor supply voltage; it will trigger protective actions if the bus sags.

## 6. Troubleshooting

| Symptom | Suggested Action |
| ------- | ---------------- |
| Build fails with missing device headers | Install the STM32H7 device family pack in Keil (`Pack Installer`). |
| USB CDC port not enumerating | Check that the `USB_DEVICE` middleware is enabled in the `.ioc` and that VBUS sensing is configured. |
| Motors do not respond | Verify CAN wiring, termination resistors, and that the correct motor mode is enabled via `enable_motor_mode`. |
| Telemetry values are zero | Ensure the correct joint index is sent in the feedback frame and that `CDC_DispatchFeedback` maps it to a configured joint. |

## 7. Host Utilities

Two helper scripts located under `tools/` streamline day-to-day operations:

- `switch_profile.py` rewrites `User/APP/control_board_profile.h` so that the
  firmware targets the desired limb controller. Example usage:

  ```bash
  python tools/switch_profile.py left_leg
  ```

  Supported profiles are `neck`, `left_arm`, `right_arm`, `left_leg`,
  `right_leg`, and `waist`. Rebuild the firmware after switching profiles.

- `motor_test.py` sends MIT-style set-points over the USB CDC port and is handy
  to validate wiring once the board is flashed. It requires `pyserial`:

  ```bash
  pip install pyserial
  python tools/motor_test.py /dev/ttyACM0 --joint left_knee --min -0.2 --max 0.2 --cycles 5
  ```

  The script accepts multiple `--joint` arguments if you want to move several
  actuators simultaneously. Each frame reuses the CAN identifiers listed in
  `docs/motor_id_setup.md` so the command takes effect immediately.

## 8. Extending the Firmware

- Add new actuator types by extending the `RobotMotorModel` enum and providing `*_fbdata` / `*_fbdata_test` helpers.
- Create additional USB commands by editing `CDC_DispatchFeedback` and the parsing logic in `usbd_cdc_if.c`.
- For deterministic control cycles, pin the controller task to a dedicated FreeRTOS timer using `xTimerCreate` in `freertos.c`.

## 9. Revision History

- **2024-05-XX** – Initial public release.
- **2024-06-XX** – Updated USB CDC feedback dispatch, added DM3507 telemetry helper, documentation refresh.

---

For questions or contributions, open an issue in the repository or contact the firmware team.
